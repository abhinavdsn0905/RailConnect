{% extends "adminpanel/admin_base.html" %}
{% block page_title %}Manage Routes{% endblock %}
{% block n_trains %}active{% endblock %}
{% block topbar_title %}Route Management{% endblock %}
{% block topbar_badge %}<span class="topbar-pill">Operations</span>{% endblock %}

{% block content %}

<div class="ph">
    <div class="flex-between mb-18">
        <div>
            <div class="ph-title">üó∫ Manage Routes</div>
            <div class="ph-sub">{{ train.train_name }} &nbsp;¬∑&nbsp; <span style="font-family:'IBM Plex Mono',monospace; font-size:13px; color:var(--c-blue);">{{ train.train_number }}</span></div>
        </div>
        <a href="{% url 'adminpanel:train_list' %}" class="btn btn-ghost">‚Üê Back to Trains</a>
    </div>
</div>

<div class="two-col">

    <!-- ADD STATION -->
    <div class="t-wrap">
        <div class="t-header">
            <span class="t-header-title">‚ûï Add Stop</span>
        </div>
        <div style="padding:24px;" class="form-stack">
            <div class="field">
                <label>Station</label>
                <select id="station_id">
                    <option value="">Select Station</option>
                    {% for station in stations %}
                        <option value="{{ station.id }}">{{ station.name }} ({{ station.code }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="field">
                <label>Arrival Time</label>
                <input type="time" id="arrival_time" style="width:100%; padding:10px 13px; background:var(--c-bg); border:1px solid var(--c-border); border-radius:var(--radius-sm); color:var(--c-text); outline:none;">
            </div>
            <div class="field">
                <label>Departure Time</label>
                <input type="time" id="departure_time" style="width:100%; padding:10px 13px; background:var(--c-bg); border:1px solid var(--c-border); border-radius:var(--radius-sm); color:var(--c-text); outline:none;">
            </div>
            <button onclick="addStation()" class="btn btn-success" style="margin-top:8px; width:100%;">Add Stop</button>
            <div id="add-msg" style="margin-top:10px; font-size:13px; display:none;"></div>
        </div>
    </div>

    <!-- ROUTE TABLE -->
    <div class="t-wrap">
        <div class="t-header">
            <span class="t-header-title">üõ§ Current Route ({{ routes|length }} stops)</span>
        </div>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Station</th>
                    <th>Arrival</th>
                    <th>Departure</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for route in routes %}
                <tr>
                    <td><span class="badge badge-blue">{{ route.stop_order }}</span></td>
                    <td><strong>{{ route.station.name }}</strong> <span class="dim-cell">({{ route.station.code }})</span></td>
                    <td class="dim-cell">{{ route.arrival_time|default:"‚Äî" }}</td>
                    <td class="dim-cell">{{ route.departure_time|default:"‚Äî" }}</td>
                    <td>
                        <button onclick="deleteStop({{ route.pk }})" class="btn btn-danger btn-sm">üóë</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5">
                        <div class="empty">
                            <div class="empty-icon">üõ§</div>
                            <p>No stops added yet. Add your first stop on the left.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<script>
async function addStation() {
    const station_id = document.getElementById("station_id").value;
    const arrival_time = document.getElementById("arrival_time").value;
    const departure_time = document.getElementById("departure_time").value;
    const msg = document.getElementById("add-msg");

    if (!station_id) {
        msg.style.display = "block";
        msg.style.color = "var(--c-red)";
        msg.textContent = "Please select a station.";
        return;
    }

    try {
        const response = await fetch("{% url 'adminpanel:add_route_station' train.pk %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ station_id, arrival_time, departure_time })
        });

        const result = await response.json();

        if (result.success) {
            location.reload();
        } else {
            msg.style.display = "block";
            msg.style.color = "var(--c-red)";
            msg.textContent = "Error adding station. Please try again.";
        }
    } catch(e) {
        msg.style.display = "block";
        msg.style.color = "var(--c-red)";
        msg.textContent = "Network error. Please try again.";
    }
}


async function deleteStop(routeId) {
    if (!confirm("Remove this stop from the route?")) return;

    const urlTemplate = "{% url 'adminpanel:delete_route_station' train.pk 0 %}";
    const url = urlTemplate.replace("0", routeId);

    try {
        const response = await fetch(url, {
            method: "DELETE",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        });

        const result = await response.json();

        if (result.success) {
            location.reload();
        } else {
            alert("Error deleting stop.");
        }
    } catch (e) {
        alert("Network error.");
    }
}
</script>
{% endblock %}